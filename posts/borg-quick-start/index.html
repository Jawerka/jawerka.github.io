<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Borg Quick Start | jawerka</title><meta name=keywords content><meta name=description content="Это переведенная нейросетями статья Borg - quick start
Установка Для установки borg:
sudo apt install borgbackup Для установки более новой версии brog:
sudo apt install python3 python3-pip -y python3 -m pip install --upgrade pip sudo pip install borgbackup borg compact может не работать в старых версиях
Глава о Borg Эта глава познакомит вас с использованием Borg и охватит различные сценарии его применения.
Пошаговый пример Перед тем как создать резервную копию, необходимо инициализировать репозиторий:"><meta name=author content="jawerka"><link rel=canonical href=https://jawerka.github.io/posts/borg-quick-start/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://jawerka.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jawerka.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jawerka.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jawerka.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jawerka.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Borg Quick Start"><meta property="og:description" content="Это переведенная нейросетями статья Borg - quick start
Установка Для установки borg:
sudo apt install borgbackup Для установки более новой версии brog:
sudo apt install python3 python3-pip -y python3 -m pip install --upgrade pip sudo pip install borgbackup borg compact может не работать в старых версиях
Глава о Borg Эта глава познакомит вас с использованием Borg и охватит различные сценарии его применения.
Пошаговый пример Перед тем как создать резервную копию, необходимо инициализировать репозиторий:"><meta property="og:type" content="article"><meta property="og:url" content="https://jawerka.github.io/posts/borg-quick-start/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-25T09:08:04+03:00"><meta property="article:modified_time" content="2024-10-25T09:08:04+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Borg Quick Start"><meta name=twitter:description content="Это переведенная нейросетями статья Borg - quick start
Установка Для установки borg:
sudo apt install borgbackup Для установки более новой версии brog:
sudo apt install python3 python3-pip -y python3 -m pip install --upgrade pip sudo pip install borgbackup borg compact может не работать в старых версиях
Глава о Borg Эта глава познакомит вас с использованием Borg и охватит различные сценарии его применения.
Пошаговый пример Перед тем как создать резервную копию, необходимо инициализировать репозиторий:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jawerka.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Borg Quick Start","item":"https://jawerka.github.io/posts/borg-quick-start/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Borg Quick Start","name":"Borg Quick Start","description":"Это переведенная нейросетями статья Borg - quick start\nУстановка Для установки borg:\nsudo apt install borgbackup Для установки более новой версии brog:\nsudo apt install python3 python3-pip -y python3 -m pip install --upgrade pip sudo pip install borgbackup borg compact может не работать в старых версиях\nГлава о Borg Эта глава познакомит вас с использованием Borg и охватит различные сценарии его применения.\nПошаговый пример Перед тем как создать резервную копию, необходимо инициализировать репозиторий:","keywords":[],"articleBody":"Это переведенная нейросетями статья Borg - quick start\nУстановка Для установки borg:\nsudo apt install borgbackup Для установки более новой версии brog:\nsudo apt install python3 python3-pip -y python3 -m pip install --upgrade pip sudo pip install borgbackup borg compact может не работать в старых версиях\nГлава о Borg Эта глава познакомит вас с использованием Borg и охватит различные сценарии его применения.\nПошаговый пример Перед тем как создать резервную копию, необходимо инициализировать репозиторий:\nborg init --encryption=repokey /path/to/repo Создайте архив с названием Monday, содержащий директории ~/src и ~/Documents:\nborg create /path/to/repo::Monday ~/src ~/Documents На следующий день создайте новый архив под названием Tuesday:\nborg create --stats /path/to/repo::Tuesday ~/src ~/Documents Эта резервная копия будет гораздо быстрее и займёт меньше места, так как будут сохранены только новые данные. Опция --stats вызовет вывод статистики о созданном архиве:\n------------------------------------------------------------------------------ Archive name: Tuesday Archive fingerprint: bd31004d58f51ea06ff735d2e5ac49376901b21d58035f8fb05dbf866566e3c2 Time (start): Tue, 2016-02-16 18:15:11 Time (end): Tue, 2016-02-16 18:15:11 Duration: 0.19 seconds Number of files: 127 ------------------------------------------------------------------------------ Original size Compressed size Deduplicated size This archive: 4.16 MB 4.17 MB 26.78 kB All archives: 8.33 MB 8.34 MB 4.19 MB Unique chunks Total chunks Chunk index: 132 261 ------------------------------------------------------------------------------ Список всех архивов в репозитории: borg list /path/to/repo Monday Mon, 2016-02-15 19:14:44 Tuesday Tue, 2016-02-16 19:15:11 Просмотр содержимого архива Monday: borg list /path/to/repo::Monday drwxr-xr-x user group 0 Mon, 2016-02-15 18:22:30 home/user/Documents -rw-r--r-- user group 7961 Mon, 2016-02-15 18:22:30 home/user/Documents/Important.doc ... Восстановление архива Monday: borg extract /path/to/repo::Monday Удаление архива Monday (не освобождает место на диске): borg delete /path/to/repo::Monday Освобождение места путём компактации сегментных файлов: borg compact /path/to/repo Примечание Borg по умолчанию работает в тихом режиме (уровень логирования — WARNING). Вы можете использовать такие опции, как --progress или --list, чтобы получать отчеты во время выполнения команд. Также можно добавить опцию -v (или --verbose, или --info), чтобы изменить уровень логирования на INFO и получать другие информационные сообщения.\nАрхивы и репозитории Архив Borg — это результат одной резервной копии (borg create). Архив хранит снимок данных файлов, находящихся “внутри” него. Позже можно извлечь или смонтировать архив, чтобы восстановить данные из резервной копии.\nРепозитории — это каталоги файловой системы, действующие как самостоятельные хранилища архивов. К репозиториям можно получить доступ локально по пути или удалённо через SSH. Внутри репозиториев содержатся блоки данных и манифест, отслеживающий, какие блоки находятся в каждом архиве. Если некоторые данные не изменились с одной резервной копии на другую, Borg может просто ссылаться на уже загруженный кусок данных (дедупликация).\nВажное примечание о свободном пространстве Перед тем как начать создавать резервные копии, убедитесь, что на файловой системе, где находится ваш репозиторий резервных копий (а также в ~/.cache), всегда достаточно свободного места. Несколько гигабайт должно хватить для большинства репозиториев, размещенных на жестких дисках. Также смотрите раздел Использование памяти индексов / кэшей.\nBorg не использует пространство, зарезервированное для root на дисках репозитория (даже при запуске от имени root). На файловых системах, которые не поддерживают этот механизм (например, XFS), рекомендуется зарезервировать некоторое пространство в самом Borg для подстраховки, отрегулировав настройку additional_free_space (хорошей отправной точкой будет 2G):\nborg config /path/to/repo additional_free_space 2G Важное примечание о разрешениях Чтобы избежать проблем с разрешениями (в вашем репозитории Borg или кэше Borg), всегда получайте доступ к репозиторию, используя одну и ту же учетную запись пользователя.\nЕсли вы хотите делать резервные копии файлов других пользователей или операционной системы, вероятно, потребуется запускать Borg от имени root (в противном случае вы получите ошибки доступа). Если вы делаете резервные копии только своих файлов, вам не нужно и не желательно запускать Borg от имени root — просто запускайте его от имени вашего обычного пользователя.\nДля локального репозитория всегда используйте одного и того же пользователя для вызова Borg.\nДля удаленного репозитория: всегда используйте, например, borg@remote_host. Вы можете использовать это от разных локальных пользователей, но удаленный пользователь, запускающий Borg и получающий доступ к репозиторию, всегда будет borg.\nЕсли вам нужно получить доступ к локальному репозиторию от разных пользователей, вы можете использовать тот же метод, используя SSH для borg@localhost.\nВажное примечание о файлах, изменяющихся в процессе резервного копирования Borg не заботится о внутренней целостности данных, которые он сохраняет. Он просто считывает и создает резервные копии каждого файла в том состоянии, в котором он находится, когда Borg к нему обращается. На активной системе это может привести к двум видам несоответствия:\nК тому времени, когда Borg создает резервную копию файла, он мог измениться с момента инициации процесса резервного копирования.\nФайл может измениться, пока Borg создает его резервную копию, что сделает файл внутренне несоответствующим.\nЕсли у вас есть набор файлов и вы хотите гарантировать, что они будут сохранены в определенном или согласованном состоянии, необходимо предпринять шаги для предотвращения изменений этих файлов в процессе резервного копирования. Существуют несколько общих методов достижения этого:\nИзбегайте запуска любых программ, которые могут изменить файлы.\nСоздавайте снимки файлов, файловых систем, контейнерных томов или логических томов. В этом случае могут быть полезны LVM или ZFS.\nДампите базы данных или останавливайте серверы баз данных.\nВыключайте виртуальные машины перед резервным копированием их образов.\nВыключайте контейнеры перед резервным копированием их томов хранения.\nДля некоторых систем Borg может работать достаточно хорошо без этих предосторожностей. Если вы просто делаете резервные копии файлов на системе, которая не очень активна (например, в типичном домашнем каталоге), Borg обычно работает достаточно хорошо без дополнительной заботы о целостности. Журналы и кэши могут быть не в идеальном состоянии, но это редко является проблемой.\nДля баз данных, виртуальных машин и контейнеров существуют специальные методы резервного копирования, которые не просто используют Borg для резервного копирования подлежащей файловой системы. Для баз данных проверьте документацию вашей базы данных на наличие техник, которые сохранят состояние базы данных между транзакциями. Для виртуальных машин рассмотрите возможность выполнения резервного копирования непосредственно на виртуальной машине или монтирования файловой системы, пока виртуальная машина выключена. Для контейнеров Docker возможно, команда “save” Docker может помочь.\nАвтоматизация резервного копирования Следующий пример скрипта предназначен для ежедневного запуска пользователем root на различных локальных машинах. Он создает резервные копии важных файлов машины (но не всей операционной системы) в репозиторий ~/backup/main на удаленном сервере. Некоторые файлы, которые не являются обязательными для этой резервной копии, исключаются. См. раздел borg help patterns для получения информации о том, как добавить дополнительные параметры исключения.\nПосле резервного копирования этот скрипт также использует подкоманду borg prune, чтобы оставить только определенное количество старых архивов и удалить остальные.\nВ завершение он использует подкоманду borg compact для удаления удаленных объектов из сегментных файлов в репозитории, чтобы сохранить место на диске.\nПеред запуском убедитесь, что репозиторий инициализирован, как указано в разделе Удаленные репозитории, и что скрипт имеет правильные разрешения для выполнения пользователем root, но не может быть выполнен или прочитан никем другим, т.е. root:root 0700.\nВы можете использовать этот скрипт в качестве отправной точки и модифицировать его по мере необходимости, чтобы он соответствовал вашей конфигурации.\nНе забудьте протестировать созданные резервные копии, чтобы убедиться, что все необходимые данные сохраняются, и что команда prune правильно сохраняет и удаляет архивы.\n#!/bin/sh # Устанавливаем это, чтобы репозиторий не нужно было указывать в командной строке: export BORG_REPO=ssh://username@example.com:2022/~/backup/main # См. раздел \"Примечания по паролю\" для получения дополнительной информации. export BORG_PASSPHRASE='XYZl0ngandsecurepa_55_phrasea\u0026\u0026123' # Некоторые вспомогательные функции и обработка ошибок: info() { printf \"\\n%s %s\\n\\n\" \"$(date)\" \"$*\" \u003e\u00262; } trap 'echo $(date) Резервное копирование прервано \u003e\u00262; exit 2' INT TERM info \"Запуск резервного копирования\" # Резервное копирование самых важных директорий в архив, названный в честь # машины, на которой в данный момент выполняется этот скрипт: borg create \\ --verbose \\ --filter AME \\ --list \\ --stats \\ --show-rc \\ --compression lz4 \\ --exclude-caches \\ --exclude 'home/*/.cache/*' \\ --exclude 'var/tmp/*' \\ \\ ::'{hostname}-{now}' \\ /etc \\ /home \\ /root \\ /var backup_exit=$? info \"Очистка репозитория\" # Используйте подкоманду `prune`, чтобы поддерживать 7 ежедневных, 4 еженедельных и 6 ежемесячных # архивов ЭТОЙ машины. Совпадение '{hostname}-*' очень важно для # ограничения операции prune архивами этой машины и предотвращения # применения к архивам других машин: borg prune \\ --list \\ --glob-archives '{hostname}-*' \\ --show-rc \\ --keep-daily 7 \\ --keep-weekly 4 \\ --keep-monthly 6 prune_exit=$? # Фактически освобождаем место на диске репозитория, сжимая сегменты info \"Сжатие репозитория\" borg compact compact_exit=$? # Используем самый высокий код выхода как глобальный код выхода global_exit=$(( backup_exit \u003e prune_exit ? backup_exit : prune_exit )) global_exit=$(( compact_exit \u003e global_exit ? compact_exit : global_exit )) if [ ${global_exit} -eq 0 ]; then info \"Резервное копирование, очистка и сжатие завершены успешно\" elif [ ${global_exit} -eq 1 ]; then info \"Резервное копирование, очистка и/или сжатие завершены с предупреждениями\" else info \"Резервное копирование, очистка и/или сжатие завершены с ошибками\" fi exit ${global_exit} Подводные камни с переменными оболочки и переменными окружения Это относится ко всем переменным окружения, которые вы хотите, чтобы Borg видел, а не только к BORG_PASSPHRASE. Краткое объяснение: всегда используйте export для вашей переменной и применяйте одинарные кавычки, если вы не уверены в поведении расширения вашей оболочки. Например:\nexport BORG_PASSPHRASE='сложный \u0026 длинный' Это связано с тем, что export делает переменные доступными для подпроцессов, одним из которых может быть Borg. Более подробную информацию о export можно найти в разделе “ENVIRONMENT” справочной страницы bash(1).\nБудьте осторожны с тем, как sudo взаимодействует с переменными окружения. Например, вы можете быть удивлены, что следующий export не влияет на вашу команду:\nexport BORG_PASSPHRASE='сложный \u0026 длинный' sudo ./yourborgwrapper.sh # все равно запрашивает пароль Для получения дополнительной информации обратитесь к справочной странице sudo(8) и env_keep в справочной странице sudoers(5).\nСовет Чтобы отладить, что ваш процесс Borg на самом деле видит, найдите его PID (ps aux | grep borg), а затем посмотрите в /proc//environ.\nПримечания по паролю Если вы используете шифрование (или аутентификацию), Borg будет интерактивно запрашивать у вас пароль для шифрования/дешифрования файла ключа / репоключа.\nПароль должен быть одной строкой текста; завершающий перевод строки будет удален.\nДля вашей безопасности вам стоит избегать пустых паролей, а также очень длинных паролей (более 256 бит энтропии).\nТакже избегайте паролей, содержащих не-ASCII символы. Технически Borg способен обрабатывать весь текст в Юникоде, но у вас могут возникнуть проблемы с воспроизведением одинаковых закодированных байтов UTF-8 или с раскладками клавиатуры, поэтому лучше избегать не-ASCII символов.\nЕсли вы хотите автоматизировать процесс, вы можете предоставить пароль напрямую или косвенно, используя некоторые переменные окружения.\nВы можете напрямую указать пароль:\n# используйте этот пароль (используйте безопасные права доступа к скрипту!): export BORG_PASSPHRASE='мой супер секретный пароль' Или попросить внешнюю программу предоставить пароль:\n# используйте менеджер паролей \"pass\" для получения пароля: export BORG_PASSCOMMAND='pass show backup' # используйте GPG для получения пароля, содержащегося в gpg-зашифрованном файле: export BORG_PASSCOMMAND='gpg --decrypt borg-passphrase.gpg' Или прочитать пароль из открытого файлового дескриптора:\nexport BORG_PASSPHRASE_FD=42 Использование аппаратных криптоустройств (таких как Nitrokey, Yubikey и других) не поддерживается напрямую в Borg, но вы можете использовать их косвенно. Например, если ваше криптоустройство поддерживает GPG и Borg вызывает gpg через BORG_PASSCOMMAND, это должно работать.\nСжатие резервных копий По умолчанию используется метод сжатия lz4 (очень быстрый, но с низким коэффициентом сжатия), однако для разных ситуаций поддерживаются и другие методы.\nВы можете использовать zstd для широкого диапазона настроек: от высокой скорости (и относительно низкого сжатия) с N=1 до высокого сжатия (и низкой скорости) с N=22.\nzstd — это современный алгоритм сжатия и может быть предпочтительным по сравнению с zlib и lzma, за исключением случаев, когда необходима совместимость с более старыми версиями Borg (\u003c 1.1.4), в которых zstd еще не поддерживался:\n$ borg create --compression zstd,N /path/to/repo::arch ~ Другие варианты: Если у вас быстрый хранилище репозитория и вы хотите минимальное использование ЦП, без сжатия:\n$ borg create --compression none /path/to/repo::arch ~ Если у вас менее быстрое хранилище репозитория и вы хотите немного большее сжатие (N=0..9, где 0 означает отсутствие сжатия, а 9 — высокое сжатие):\n$ borg create --compression zlib,N /path/to/repo::arch ~ Если у вас очень медленное хранилище репозитория и вы хотите высокое сжатие (N=0..9, где 0 означает низкое сжатие, а 9 — высокое сжатие):\n$ borg create --compression lzma,N /path/to/repo::arch ~ Вам потребуется немного поэкспериментировать, чтобы найти наилучший вариант сжатия для вашего случая. Обратите внимание на нагрузку на процессор и пропускную способность.\nШифрование репозитория Вы можете выбрать режим шифрования репозитория во время его создания:\n$ borg init --encryption=MODE PATH Для получения списка доступных режимов шифрования и их описаний, пожалуйста, обратитесь к borg init.\nЕсли вы используете шифрование, все данные шифруются на клиенте перед записью в репозиторий. Это означает, что злоумышленник, который сможет скомпрометировать хост, содержащий зашифрованный репозиторий, не сможет получить доступ к каким-либо данным, даже во время выполнения резервного копирования.\nКлючевые материалы хранятся в зашифрованном виде и могут быть расшифрованы только при предоставлении правильного пароля.\nДля автоматизированных резервных копий пароль можно указать с помощью переменной окружения BORG_PASSPHRASE.\nПримечание Будьте осторожны с тем, как вы устанавливаете эту переменную окружения, смотрите эту заметку о переменных окружения для паролей для получения дополнительной информации.\nПредупреждение Данные репозитория полностью недоступны без ключа и пароля к ключу.\nСоздайте резервную копию файла ключа (в режиме keyfile) или файла конфигурации репозитория (в режиме repokey) и храните ее в безопасном месте, чтобы вы все еще имели ключ на случай его повреждения или потери. Также храните ваш пароль в безопасном месте. Вы можете сделать резервные копии с помощью подкоманды borg key export.\nЕсли вы хотите напечатать резервную копию вашего ключа на бумаге, используйте опцию --paper этой команды и распечатайте результат, или распечатайте этот шаблон, если вам нужна версия с QR-кодом.\nРезервная копия внутри резервной копии, зашифрованная с помощью этого ключа/пароля, конечно же, не поможет вам в этом.\nВ случае потери вашего репозитория и информации о безопасности, но наличии старой копии для восстановления, не используйте ее позднее для создания новых резервных копий — вы столкнетесь с проблемами безопасности (повторное использование значений счетчика nonce). Лучше инициализировать новый репозиторий Borg. Также смотрите: Мой репозиторий поврежден, как я могу восстановить его из более ранней копии?\nУдаленные репозитории Borg может инициализировать и получать доступ к репозиториям на удаленных хостах, если хост доступен через SSH. Это быстрее и проще, когда Borg установлен на удаленном хосте. В этом случае используется следующий синтаксис:\n$ borg init user@hostname:/path/to/repo Примечание: Пожалуйста, смотрите раздел использования для получения полной документации по URL репозиториев.\nУдаленные операции через SSH можно автоматизировать с помощью SSH-ключей. Вы можете ограничить использование пары SSH-ключей, добавив принудительную команду в публичный ключ SSH в файле authorized_keys на удаленном сервере. В этом примере Borg будет запущен в режиме сервера и ограничен определенным файловым путем:\ncommand=\"borg serve --restrict-to-path /path/to/repo\",restrict ssh-rsa AAAAB3[...] Если установка Borg на удаленном хосте невозможна, все еще можно использовать удаленный хост для хранения репозитория, монтируя удаленную файловую систему, например, с помощью sshfs:\n$ sshfs user@hostname:/path/to /path/to $ borg init /path/to/repo $ fusermount -u /path/to Вы также можете использовать другие удаленные файловые системы аналогичным образом. Просто будьте осторожны: не все файловые системы достаточно стабильны и работают хорошо для использования в резервном копировании.\nВосстановление резервной копии Обратите внимание, что мы здесь описываем только самые основные команды и параметры. Для получения дополнительной информации обратитесь к справочнику команд.\nДля восстановления вы обычно хотите работать на том же компьютере тем же пользователем, который использовался для создания резервных копий нужных файлов. Это позволяет избежать многих проблем:\nотсутствие путаницы с путями; такое же сопоставление имен пользователей/групп с идентификаторами пользователей/групп; отсутствие проблем с правами доступа; скорее всего, у вас уже есть рабочая настройка Borg: возможно, с переменной окружения для ключевой фразы (для зашифрованных репозиториев); возможно, с файлом ключа для репозитория (не требуется для режима repokey); возможно, с SSH-ключом для сервера репозитория (не требуется для локально смонтированных репозиториев); возможно, с действительным кэшем Borg для этого репозитория (быстрее, чем его перестройка). Пользователь может быть:\nroot (если были сделаны полные резервные копии, включая системные файлы или файлы нескольких пользователей); конкретный пользователь, использующий sudo для выполнения Borg от имени root; конкретный пользователь (если были сделаны резервные копии файлов этого пользователя). Репозиторий резервного копирования может быть:\nв локальном каталоге (например, на локально смонтированном USB-накопителе); на удаленном сервере резервного копирования, доступном по SSH (клиент/сервер). Если репозиторий зашифрован, вам также понадобится ключ и пароль (который защищает ключ).\nКлюч может находиться:\nв репозитории (repokey режим).\nЭто просто, обычно это «просто работает».\nв домашнем каталоге пользователя, который делал резервную копию (keyfile режим).\nЭто может потребовать немного больше усилий:\nесли вы только что потеряли этот домашний каталог и вам нужно восстановить ключ Borg (например, из отдельной резервной копии, которую вы сделали, или от другого пользователя или машины, имеющей доступ к тому же репозиторию); если вам нужно выяснить правильную машину/пользователя/домашний каталог, где был запущен клиент Borg для создания резервных копий. Пароль для ключа может быть:\nвведен интерактивно во время резервного копирования (не практично, если резервное копирование автоматизировано/без присмотра); получен через механизм, управляемый переменной окружения в скрипте резервного копирования (ищите там BORG_PASSPHRASE, BORG_PASSCOMMAND и т. д. и просто сделайте это так). Существуют два способа восстановить файлы из репозитория резервного копирования Borg:\nborg mount — используйте это, если:\nвы не совсем знаете, какие файлы хотите восстановить; вы не знаете, какой архив содержит нужные файлы; вам нужно просмотреть файлы/каталоги перед тем, как решить, что вы хотите; вам нужно восстановить относительно небольшой объем данных; вам не важен восстановление объектов, которые FUSE-монтирование пока не поддерживает (например, специальные флаги файловой системы, ACL); у вас клиент с хорошими ресурсами (ОЗУ, ЦП, временное дисковое пространство); вы хотите использовать файловый менеджер для восстановления (копирования) файлов, а не команды оболочки borg extract. borg extract — используйте это, если:\nвы точно знаете, что хотите (репозиторий, архив, путь); вам нужно восстановить большой объем файлов (лучшая скорость); вы хотите максимально полное воспроизведение метаданных файлов (например, специальные флаги файловой системы, ACL); у вас клиент с низкими ресурсами (ОЗУ, ЦП, временное дисковое пространство). Пример с borg mount: # Откройте новый, отдельный терминал (этот терминал будет заблокирован до размонтирования). # Теперь мы узнаем имена архивов, которые у нас есть в репозитории: borg list /mnt/backup/borg_repo # Смонтируем один архив из репозитория Borg: borg mount /mnt/backup/borg_repo::myserver-system-2019-08-11 /mnt/borg # Альтернативно, смонтируем все архивы из репозитория Borg (медленнее): borg mount /mnt/backup/borg_repo /mnt/borg # Может потребоваться некоторое время, прежде чем вы увидите содержимое в /mnt/borg. # Теперь используйте другой терминал или файловый браузер и посмотрите содержимое в /mnt/borg. # Когда закончите, размонтируйте, чтобы разблокировать репозиторий и разблокировать терминал: borg umount /mnt/borg Пример с borg extract: # borg extract всегда извлекает в текущий каталог, и этот каталог # должен быть пустым (borg не поддерживает преобразование непустого каталога в # состояние, которое присутствует в вашем архиве резервной копии). mkdir borg_restore cd borg_restore # Теперь мы узнаем имена архивов, которые у нас есть в репозитории: borg list /mnt/backup/borg_repo # Мы можем выяснить содержимое архива, особенно структуру пути: borg list /mnt/backup/borg_repo::myserver-system-2019-08-11 # Извлекаем только некоторый конкретный путь (заметьте: без начального / !): borg extract /mnt/backup/borg_repo::myserver-system-2019-08-11 path/to/extract # Альтернативно, мы можем полностью извлечь архив: borg extract /mnt/backup/borg_repo::myserver-system-2019-08-11 # Теперь переместите файлы в нужное место... Различия при использовании удаленного сервера резервного копирования Borg: В целом, все то же самое, что и с локальным репозиторием, но вам нужно ссылаться на репозиторий с помощью URL ssh://.\nВ данном примере borg — это имя пользователя, используемое для входа в машину backup.example.org, которая работает по SSH на порту 2222 и имеет репозиторий Borg в /path/to/repo.\nВместо указания полного доменного имени (FQDN) или имени хоста вы также можете указать IP-адрес.\nКак обычно, вам нужен либо пароль для входа, либо сервер резервного копирования может иметь аутентификацию, настроенную через SSH authorized_keys (что вероятно, если резервное копирование выполнялось без присмотра).\nborg mount ssh://borg@backup.example.org:2222/path/to/repo /mnt/borg # или borg extract ssh://borg@backup.example.org:2222/path/to/repo Установка\nИспользование\n","wordCount":"3100","inLanguage":"en","datePublished":"2024-10-25T09:08:04+03:00","dateModified":"2024-10-25T09:08:04+03:00","author":{"@type":"Person","name":"jawerka"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jawerka.github.io/posts/borg-quick-start/"},"publisher":{"@type":"Organization","name":"jawerka","logo":{"@type":"ImageObject","url":"https://jawerka.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jawerka.github.io/ accesskey=h title="jawerka (Alt + H)">jawerka</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Borg Quick Start</h1><div class=post-meta><span title='2024-10-25 09:08:04 +0300 +0300'>October 25, 2024</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;jawerka</div></header><div class=post-content><p>Это переведенная нейросетями статья <a href=https://borgbackup.readthedocs.io/en/stable/quickstart.html>Borg - quick start</a></p><hr><h3 id=установка>Установка<a hidden class=anchor aria-hidden=true href=#установка>#</a></h3><p>Для установки borg:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install borgbackup
</span></span></code></pre></div><p>Для установки более новой версии brog:</p><pre tabindex=0><code>sudo apt install python3 python3-pip -y

python3 -m pip install --upgrade pip

sudo pip install borgbackup
</code></pre><p><em><code>borg compact</code> может не работать в старых версиях</em></p><h2 id=глава-о-borg>Глава о Borg<a hidden class=anchor aria-hidden=true href=#глава-о-borg>#</a></h2><p>Эта глава познакомит вас с использованием Borg и охватит различные сценарии его применения.</p><h3 id=пошаговый-пример>Пошаговый пример<a hidden class=anchor aria-hidden=true href=#пошаговый-пример>#</a></h3><p>Перед тем как создать резервную копию, необходимо инициализировать репозиторий:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg init --encryption<span style=color:#f92672>=</span>repokey /path/to/repo
</span></span></code></pre></div><p>Создайте архив с названием <code>Monday</code>, содержащий директории <code>~/src</code> и <code>~/Documents</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg create /path/to/repo::Monday ~/src ~/Documents
</span></span></code></pre></div><p>На следующий день создайте новый архив под названием <code>Tuesday</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg create --stats /path/to/repo::Tuesday ~/src ~/Documents
</span></span></code></pre></div><p>Эта резервная копия будет гораздо быстрее и займёт меньше места, так как будут сохранены только новые данные. Опция <code>--stats</code> вызовет вывод статистики о созданном архиве:</p><pre tabindex=0><code>------------------------------------------------------------------------------
Archive name: Tuesday
Archive fingerprint: bd31004d58f51ea06ff735d2e5ac49376901b21d58035f8fb05dbf866566e3c2
Time (start): Tue, 2016-02-16 18:15:11
Time (end):   Tue, 2016-02-16 18:15:11

Duration: 0.19 seconds
Number of files: 127
------------------------------------------------------------------------------
                      Original size      Compressed size    Deduplicated size
This archive:                4.16 MB              4.17 MB             26.78 kB
All archives:                8.33 MB              8.34 MB              4.19 MB

                      Unique chunks         Total chunks
Chunk index:                     132                  261
------------------------------------------------------------------------------
</code></pre><h3 id=список-всех-архивов-в-репозитории>Список всех архивов в репозитории:<a hidden class=anchor aria-hidden=true href=#список-всех-архивов-в-репозитории>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg list /path/to/repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Monday                               Mon, 2016-02-15 19:14:44
</span></span><span style=display:flex><span>Tuesday                              Tue, 2016-02-16 19:15:11
</span></span></code></pre></div><h3 id=просмотр-содержимого-архива-monday>Просмотр содержимого архива <code>Monday</code>:<a hidden class=anchor aria-hidden=true href=#просмотр-содержимого-архива-monday>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg list /path/to/repo::Monday
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>drwxr-xr-x user   group          <span style=color:#ae81ff>0</span> Mon, 2016-02-15 18:22:30 home/user/Documents
</span></span><span style=display:flex><span>-rw-r--r-- user   group       <span style=color:#ae81ff>7961</span> Mon, 2016-02-15 18:22:30 home/user/Documents/Important.doc
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=восстановление-архива-monday>Восстановление архива <code>Monday</code>:<a hidden class=anchor aria-hidden=true href=#восстановление-архива-monday>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg extract /path/to/repo::Monday
</span></span></code></pre></div><h3 id=удаление-архива-monday-не-освобождает-место-на-диске>Удаление архива <code>Monday</code> (не освобождает место на диске):<a hidden class=anchor aria-hidden=true href=#удаление-архива-monday-не-освобождает-место-на-диске>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg delete /path/to/repo::Monday
</span></span></code></pre></div><h3 id=освобождение-места-путём-компактации-сегментных-файлов>Освобождение места путём компактации сегментных файлов:<a hidden class=anchor aria-hidden=true href=#освобождение-места-путём-компактации-сегментных-файлов>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg compact /path/to/repo
</span></span></code></pre></div><h3 id=примечание>Примечание<a hidden class=anchor aria-hidden=true href=#примечание>#</a></h3><p>Borg по умолчанию работает в тихом режиме (уровень логирования — WARNING). Вы можете использовать такие опции, как <code>--progress</code> или <code>--list</code>, чтобы получать отчеты во время выполнения команд. Также можно добавить опцию <code>-v</code> (или <code>--verbose</code>, или <code>--info</code>), чтобы изменить уровень логирования на INFO и получать другие информационные сообщения.</p><h2 id=архивы-и-репозитории>Архивы и репозитории<a hidden class=anchor aria-hidden=true href=#архивы-и-репозитории>#</a></h2><p><em>Архив Borg</em> — это результат одной резервной копии (<code>borg create</code>). Архив хранит снимок данных файлов, находящихся &ldquo;внутри&rdquo; него. Позже можно извлечь или смонтировать архив, чтобы восстановить данные из резервной копии.</p><p><em>Репозитории</em> — это каталоги файловой системы, действующие как самостоятельные хранилища архивов. К репозиториям можно получить доступ локально по пути или удалённо через SSH. Внутри репозиториев содержатся блоки данных и манифест, отслеживающий, какие блоки находятся в каждом архиве. Если некоторые данные не изменились с одной резервной копии на другую, Borg может просто ссылаться на уже загруженный кусок данных (дедупликация).</p><h2 id=важное-примечание-о-свободном-пространстве>Важное примечание о свободном пространстве<a hidden class=anchor aria-hidden=true href=#важное-примечание-о-свободном-пространстве>#</a></h2><p>Перед тем как начать создавать резервные копии, убедитесь, что на файловой системе, где находится ваш репозиторий резервных копий (а также в <code>~/.cache</code>), всегда достаточно свободного места. Несколько гигабайт должно хватить для большинства репозиториев, размещенных на жестких дисках. Также смотрите раздел <a href=https://borgbackup.readthedocs.io/en/stable/internals/data-structures.html#cache-memory-usage>Использование памяти индексов / кэшей</a>.</p><p>Borg не использует пространство, зарезервированное для <code>root</code> на дисках репозитория (даже при запуске от имени <code>root</code>). На файловых системах, которые не поддерживают этот механизм (например, XFS), рекомендуется зарезервировать некоторое пространство в самом Borg для подстраховки, отрегулировав настройку <code>additional_free_space</code> (хорошей отправной точкой будет <code>2G</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg config /path/to/repo additional_free_space 2G
</span></span></code></pre></div><h2 id=важное-примечание-о-разрешениях>Важное примечание о разрешениях<a hidden class=anchor aria-hidden=true href=#важное-примечание-о-разрешениях>#</a></h2><p>Чтобы избежать проблем с разрешениями (в вашем репозитории Borg или кэше Borg), <strong>всегда получайте доступ к репозиторию, используя одну и ту же учетную запись пользователя</strong>.</p><p>Если вы хотите делать резервные копии файлов других пользователей или операционной системы, вероятно, потребуется запускать Borg от имени <code>root</code> (в противном случае вы получите ошибки доступа). Если вы делаете резервные копии только своих файлов, вам не нужно и не желательно запускать Borg от имени <code>root</code> — просто запускайте его от имени вашего обычного пользователя.</p><p>Для локального репозитория всегда используйте одного и того же пользователя для вызова Borg.</p><p>Для удаленного репозитория: всегда используйте, например, <code>borg@remote_host</code>. Вы можете использовать это от разных локальных пользователей, но удаленный пользователь, запускающий Borg и получающий доступ к репозиторию, всегда будет <code>borg</code>.</p><p>Если вам нужно получить доступ к локальному репозиторию от разных пользователей, вы можете использовать тот же метод, используя SSH для <code>borg@localhost</code>.</p><h2 id=важное-примечание-о-файлах-изменяющихся-в-процессе-резервного-копирования>Важное примечание о файлах, изменяющихся в процессе резервного копирования<a hidden class=anchor aria-hidden=true href=#важное-примечание-о-файлах-изменяющихся-в-процессе-резервного-копирования>#</a></h2><p>Borg не заботится о внутренней целостности данных, которые он сохраняет. Он просто считывает и создает резервные копии каждого файла в том состоянии, в котором он находится, когда Borg к нему обращается. На активной системе это может привести к двум видам несоответствия:</p><ul><li><p>К тому времени, когда Borg создает резервную копию файла, он мог измениться с момента инициации процесса резервного копирования.</p></li><li><p>Файл может измениться, пока Borg создает его резервную копию, что сделает файл внутренне несоответствующим.</p></li></ul><p>Если у вас есть набор файлов и вы хотите гарантировать, что они будут сохранены в определенном или согласованном состоянии, необходимо предпринять шаги для предотвращения изменений этих файлов в процессе резервного копирования. Существуют несколько общих методов достижения этого:</p><ul><li><p>Избегайте запуска любых программ, которые могут изменить файлы.</p></li><li><p>Создавайте снимки файлов, файловых систем, контейнерных томов или логических томов. В этом случае могут быть полезны LVM или ZFS.</p></li><li><p>Дампите базы данных или останавливайте серверы баз данных.</p></li><li><p>Выключайте виртуальные машины перед резервным копированием их образов.</p></li><li><p>Выключайте контейнеры перед резервным копированием их томов хранения.</p></li></ul><p>Для некоторых систем Borg может работать достаточно хорошо без этих предосторожностей. Если вы просто делаете резервные копии файлов на системе, которая не очень активна (например, в типичном домашнем каталоге), Borg обычно работает достаточно хорошо без дополнительной заботы о целостности. Журналы и кэши могут быть не в идеальном состоянии, но это редко является проблемой.</p><p>Для баз данных, виртуальных машин и контейнеров существуют специальные методы резервного копирования, которые не просто используют Borg для резервного копирования подлежащей файловой системы. Для баз данных проверьте документацию вашей базы данных на наличие техник, которые сохранят состояние базы данных между транзакциями. Для виртуальных машин рассмотрите возможность выполнения резервного копирования непосредственно на виртуальной машине или монтирования файловой системы, пока виртуальная машина выключена. Для контейнеров Docker возможно, команда &ldquo;save&rdquo; Docker может помочь.</p><h2 id=автоматизация-резервного-копирования>Автоматизация резервного копирования<a hidden class=anchor aria-hidden=true href=#автоматизация-резервного-копирования>#</a></h2><p>Следующий пример скрипта предназначен для ежедневного запуска пользователем <code>root</code> на различных локальных машинах. Он создает резервные копии важных файлов машины (но не всей операционной системы) в репозиторий <code>~/backup/main</code> на удаленном сервере. Некоторые файлы, которые не являются обязательными для этой резервной копии, исключаются. См. раздел <a href=https://borgbackup.readthedocs.io/en/stable/usage/help.html#borg-patterns>borg help patterns</a> для получения информации о том, как добавить дополнительные параметры исключения.</p><p>После резервного копирования этот скрипт также использует подкоманду <a href=https://borgbackup.readthedocs.io/en/stable/usage/prune.html#borg-prune>borg prune</a>, чтобы оставить только определенное количество старых архивов и удалить остальные.</p><p>В завершение он использует подкоманду <a href=https://borgbackup.readthedocs.io/en/stable/usage/compact.html#borg-compact>borg compact</a> для удаления удаленных объектов из сегментных файлов в репозитории, чтобы сохранить место на диске.</p><p>Перед запуском убедитесь, что репозиторий инициализирован, как указано в разделе <a href=https://borgbackup.readthedocs.io/en/stable/quickstart.html#remote-repos>Удаленные репозитории</a>, и что скрипт имеет правильные разрешения для выполнения пользователем <code>root</code>, но не может быть выполнен или прочитан никем другим, т.е. <code>root:root 0700</code>.</p><p>Вы можете использовать этот скрипт в качестве отправной точки и модифицировать его по мере необходимости, чтобы он соответствовал вашей конфигурации.</p><p>Не забудьте протестировать созданные резервные копии, чтобы убедиться, что все необходимые данные сохраняются, и что команда <code>prune</code> правильно сохраняет и удаляет архивы.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># Устанавливаем это, чтобы репозиторий не нужно было указывать в командной строке:</span>
</span></span><span style=display:flex><span>export BORG_REPO<span style=color:#f92672>=</span>ssh://username@example.com:2022/~/backup/main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># См. раздел &#34;Примечания по паролю&#34; для получения дополнительной информации.</span>
</span></span><span style=display:flex><span>export BORG_PASSPHRASE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;XYZl0ngandsecurepa_55_phrasea&amp;&amp;123&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Некоторые вспомогательные функции и обработка ошибок:</span>
</span></span><span style=display:flex><span>info<span style=color:#f92672>()</span> <span style=color:#f92672>{</span> printf <span style=color:#e6db74>&#34;\n%s %s\n\n&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$*<span style=color:#e6db74>&#34;</span> &gt;&amp;2; <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>trap <span style=color:#e6db74>&#39;echo $(date) Резервное копирование прервано &gt;&amp;2; exit 2&#39;</span> INT TERM
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>info <span style=color:#e6db74>&#34;Запуск резервного копирования&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Резервное копирование самых важных директорий в архив, названный в честь</span>
</span></span><span style=display:flex><span><span style=color:#75715e># машины, на которой в данный момент выполняется этот скрипт:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>borg create                         <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --verbose                       <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --filter AME                    <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --list                          <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --stats                         <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --show-rc                       <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --compression lz4               <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --exclude-caches                <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --exclude <span style=color:#e6db74>&#39;home/*/.cache/*&#39;</span>     <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --exclude <span style=color:#e6db74>&#39;var/tmp/*&#39;</span>           <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                                    <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ::<span style=color:#e6db74>&#39;{hostname}-{now}&#39;</span>            <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /etc                            <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /home                           <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /root                           <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    /var
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>backup_exit<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>info <span style=color:#e6db74>&#34;Очистка репозитория&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Используйте подкоманду `prune`, чтобы поддерживать 7 ежедневных, 4 еженедельных и 6 ежемесячных</span>
</span></span><span style=display:flex><span><span style=color:#75715e># архивов ЭТОЙ машины. Совпадение &#39;{hostname}-*&#39; очень важно для</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ограничения операции prune архивами этой машины и предотвращения</span>
</span></span><span style=display:flex><span><span style=color:#75715e># применения к архивам других машин:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>borg prune                          <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --list                          <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --glob-archives <span style=color:#e6db74>&#39;{hostname}-*&#39;</span>  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --show-rc                       <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --keep-daily    <span style=color:#ae81ff>7</span>               <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --keep-weekly   <span style=color:#ae81ff>4</span>               <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --keep-monthly  <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>prune_exit<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Фактически освобождаем место на диске репозитория, сжимая сегменты</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>info <span style=color:#e6db74>&#34;Сжатие репозитория&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>borg compact
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>compact_exit<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Используем самый высокий код выхода как глобальный код выхода</span>
</span></span><span style=display:flex><span>global_exit<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span> backup_exit &gt; prune_exit ? backup_exit : prune_exit <span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>global_exit<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span> compact_exit &gt; global_exit ? compact_exit : global_exit <span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>${</span>global_exit<span style=color:#e6db74>}</span> -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    info <span style=color:#e6db74>&#34;Резервное копирование, очистка и сжатие завершены успешно&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>${</span>global_exit<span style=color:#e6db74>}</span> -eq <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    info <span style=color:#e6db74>&#34;Резервное копирование, очистка и/или сжатие завершены с предупреждениями&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    info <span style=color:#e6db74>&#34;Резервное копирование, очистка и/или сжатие завершены с ошибками&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit <span style=color:#e6db74>${</span>global_exit<span style=color:#e6db74>}</span>
</span></span></code></pre></div><h2 id=подводные-камни-с-переменными-оболочки-и-переменными-окружения>Подводные камни с переменными оболочки и переменными окружения<a hidden class=anchor aria-hidden=true href=#подводные-камни-с-переменными-оболочки-и-переменными-окружения>#</a></h2><p>Это относится ко всем переменным окружения, которые вы хотите, чтобы Borg видел, а не только к <code>BORG_PASSPHRASE</code>. Краткое объяснение: всегда используйте <code>export</code> для вашей переменной и применяйте одинарные кавычки, если вы не уверены в поведении расширения вашей оболочки. Например:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export BORG_PASSPHRASE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;сложный &amp; длинный&#39;</span>
</span></span></code></pre></div><p>Это связано с тем, что <code>export</code> делает переменные доступными для подпроцессов, одним из которых может быть Borg. Более подробную информацию о <code>export</code> можно найти в разделе “ENVIRONMENT” справочной страницы bash(1).</p><p>Будьте осторожны с тем, как <code>sudo</code> взаимодействует с переменными окружения. Например, вы можете быть удивлены, что следующий <code>export</code> не влияет на вашу команду:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export BORG_PASSPHRASE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;сложный &amp; длинный&#39;</span>
</span></span><span style=display:flex><span>sudo ./yourborgwrapper.sh  <span style=color:#75715e># все равно запрашивает пароль</span>
</span></span></code></pre></div><p>Для получения дополнительной информации обратитесь к справочной странице sudo(8) и <code>env_keep</code> в справочной странице sudoers(5).</p><h3 id=совет>Совет<a hidden class=anchor aria-hidden=true href=#совет>#</a></h3><p>Чтобы отладить, что ваш процесс Borg на самом деле видит, найдите его PID (<code>ps aux | grep borg</code>), а затем посмотрите в <code>/proc/&lt;PID>/environ</code>.</p><h2 id=примечания-по-паролю>Примечания по паролю<a hidden class=anchor aria-hidden=true href=#примечания-по-паролю>#</a></h2><p>Если вы используете шифрование (или аутентификацию), Borg будет интерактивно запрашивать у вас пароль для шифрования/дешифрования файла ключа / репоключа.</p><p>Пароль должен быть одной строкой текста; завершающий перевод строки будет удален.</p><p>Для вашей безопасности вам стоит избегать пустых паролей, а также очень длинных паролей (более 256 бит энтропии).</p><p>Также избегайте паролей, содержащих не-ASCII символы. Технически Borg способен обрабатывать весь текст в Юникоде, но у вас могут возникнуть проблемы с воспроизведением одинаковых закодированных байтов UTF-8 или с раскладками клавиатуры, поэтому лучше избегать не-ASCII символов.</p><p>Если вы хотите автоматизировать процесс, вы можете предоставить пароль напрямую или косвенно, используя некоторые переменные окружения.</p><p>Вы можете напрямую указать пароль:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># используйте этот пароль (используйте безопасные права доступа к скрипту!):</span>
</span></span><span style=display:flex><span>export BORG_PASSPHRASE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;мой супер секретный пароль&#39;</span>
</span></span></code></pre></div><p>Или попросить внешнюю программу предоставить пароль:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># используйте менеджер паролей &#34;pass&#34; для получения пароля:</span>
</span></span><span style=display:flex><span>export BORG_PASSCOMMAND<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;pass show backup&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># используйте GPG для получения пароля, содержащегося в gpg-зашифрованном файле:</span>
</span></span><span style=display:flex><span>export BORG_PASSCOMMAND<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;gpg --decrypt borg-passphrase.gpg&#39;</span>
</span></span></code></pre></div><p>Или прочитать пароль из открытого файлового дескриптора:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export BORG_PASSPHRASE_FD<span style=color:#f92672>=</span><span style=color:#ae81ff>42</span>
</span></span></code></pre></div><p>Использование аппаратных криптоустройств (таких как Nitrokey, Yubikey и других) не поддерживается напрямую в Borg, но вы можете использовать их косвенно. Например, если ваше криптоустройство поддерживает GPG и Borg вызывает <code>gpg</code> через <code>BORG_PASSCOMMAND</code>, это должно работать.</p><h1 id=сжатие-резервных-копий>Сжатие резервных копий<a hidden class=anchor aria-hidden=true href=#сжатие-резервных-копий>#</a></h1><p>По умолчанию используется метод сжатия <code>lz4</code> (очень быстрый, но с низким коэффициентом сжатия), однако для разных ситуаций поддерживаются и другие методы.</p><p>Вы можете использовать <code>zstd</code> для широкого диапазона настроек: от высокой скорости (и относительно низкого сжатия) с <code>N=1</code> до высокого сжатия (и низкой скорости) с <code>N=22</code>.</p><p><code>zstd</code> — это современный алгоритм сжатия и может быть предпочтительным по сравнению с <code>zlib</code> и <code>lzma</code>, за исключением случаев, когда необходима совместимость с более старыми версиями Borg (&lt; 1.1.4), в которых <code>zstd</code> еще не поддерживался:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ borg create --compression zstd,N /path/to/repo::arch ~ 
</span></span></code></pre></div><h3 id=другие-варианты>Другие варианты:<a hidden class=anchor aria-hidden=true href=#другие-варианты>#</a></h3><p>Если у вас быстрый хранилище репозитория и вы хотите минимальное использование ЦП, без сжатия:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ borg create --compression none /path/to/repo::arch ~
</span></span></code></pre></div><p>Если у вас менее быстрое хранилище репозитория и вы хотите немного большее сжатие (N=0..9, где 0 означает отсутствие сжатия, а 9 — высокое сжатие):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ borg create --compression zlib,N /path/to/repo::arch ~
</span></span></code></pre></div><p>Если у вас очень медленное хранилище репозитория и вы хотите высокое сжатие (N=0..9, где 0 означает низкое сжатие, а 9 — высокое сжатие):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ borg create --compression lzma,N /path/to/repo::arch ~
</span></span></code></pre></div><p>Вам потребуется немного поэкспериментировать, чтобы найти наилучший вариант сжатия для вашего случая. Обратите внимание на нагрузку на процессор и пропускную способность.</p><h2 id=шифрование-репозитория>Шифрование репозитория<a hidden class=anchor aria-hidden=true href=#шифрование-репозитория>#</a></h2><p>Вы можете выбрать режим шифрования репозитория во время его создания:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ borg init --encryption<span style=color:#f92672>=</span>MODE PATH
</span></span></code></pre></div><p>Для получения списка доступных режимов шифрования и их описаний, пожалуйста, обратитесь к <a href=https://borgbackup.readthedocs.io/en/stable/usage/init.html#borg-init>borg init</a>.</p><p>Если вы используете шифрование, все данные шифруются на клиенте перед записью в репозиторий. Это означает, что злоумышленник, который сможет скомпрометировать хост, содержащий зашифрованный репозиторий, не сможет получить доступ к каким-либо данным, даже во время выполнения резервного копирования.</p><p>Ключевые материалы хранятся в зашифрованном виде и могут быть расшифрованы только при предоставлении правильного пароля.</p><p>Для автоматизированных резервных копий пароль можно указать с помощью переменной окружения <code>BORG_PASSPHRASE</code>.</p><h3 id=примечание-1>Примечание<a hidden class=anchor aria-hidden=true href=#примечание-1>#</a></h3><p>Будьте осторожны с тем, как вы устанавливаете эту переменную окружения, смотрите <a href=https://borgbackup.readthedocs.io/en/stable/faq.html#password-env>эту заметку о переменных окружения для паролей</a> для получения дополнительной информации.</p><h3 id=предупреждение>Предупреждение<a hidden class=anchor aria-hidden=true href=#предупреждение>#</a></h3><p>Данные репозитория полностью недоступны без ключа и пароля к ключу.</p><p>Создайте резервную копию файла ключа (в режиме <code>keyfile</code>) или файла конфигурации репозитория (в режиме <code>repokey</code>) и храните ее в безопасном месте, чтобы вы все еще имели ключ на случай его повреждения или потери. Также храните ваш пароль в безопасном месте. Вы можете сделать резервные копии с помощью подкоманды <a href=https://borgbackup.readthedocs.io/en/stable/usage/key.html#borg-key-export>borg key export</a>.</p><p>Если вы хотите напечатать резервную копию вашего ключа на бумаге, используйте опцию <code>--paper</code> этой команды и распечатайте результат, или распечатайте этот <a href=https://borgbackup.readthedocs.io/en/stable/paperkey.html>шаблон</a>, если вам нужна версия с QR-кодом.</p><p>Резервная копия внутри резервной копии, зашифрованная с помощью этого ключа/пароля, конечно же, не поможет вам в этом.</p><p>В случае потери вашего репозитория и информации о безопасности, но наличии старой копии для восстановления, не используйте ее позднее для создания новых резервных копий — вы столкнетесь с проблемами безопасности (повторное использование значений счетчика nonce). Лучше инициализировать новый репозиторий Borg. Также смотрите: <a href=https://borgbackup.readthedocs.io/en/stable/faq.html#faq-corrupt-repo>Мой репозиторий поврежден, как я могу восстановить его из более ранней копии?</a></p><h2 id=удаленные-репозитории>Удаленные репозитории<a hidden class=anchor aria-hidden=true href=#удаленные-репозитории>#</a></h2><p>Borg может инициализировать и получать доступ к репозиториям на удаленных хостах, если хост доступен через SSH. Это быстрее и проще, когда Borg установлен на удаленном хосте. В этом случае используется следующий синтаксис:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ borg init user@hostname:/path/to/repo
</span></span></code></pre></div><p><strong>Примечание:</strong> Пожалуйста, смотрите раздел использования для получения полной документации по URL репозиториев.</p><p>Удаленные операции через SSH можно автоматизировать с помощью SSH-ключей. Вы можете ограничить использование пары SSH-ключей, добавив принудительную команду в публичный ключ SSH в файле <code>authorized_keys</code> на удаленном сервере. В этом примере Borg будет запущен в режиме сервера и ограничен определенным файловым путем:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>command<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;borg serve --restrict-to-path /path/to/repo&#34;</span>,restrict ssh-rsa AAAAB3<span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Если установка Borg на удаленном хосте невозможна, все еще можно использовать удаленный хост для хранения репозитория, монтируя удаленную файловую систему, например, с помощью sshfs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sshfs user@hostname:/path/to /path/to
</span></span><span style=display:flex><span>$ borg init /path/to/repo
</span></span><span style=display:flex><span>$ fusermount -u /path/to
</span></span></code></pre></div><p>Вы также можете использовать другие удаленные файловые системы аналогичным образом. Просто будьте осторожны: не все файловые системы достаточно стабильны и работают хорошо для использования в резервном копировании.</p><h2 id=восстановление-резервной-копии>Восстановление резервной копии<a hidden class=anchor aria-hidden=true href=#восстановление-резервной-копии>#</a></h2><p>Обратите внимание, что мы здесь описываем только самые основные команды и параметры. Для получения дополнительной информации обратитесь к справочнику команд.</p><p>Для восстановления вы обычно хотите работать <strong>на том же компьютере тем же пользователем</strong>, который использовался для создания резервных копий нужных файлов. Это позволяет избежать многих проблем:</p><ul><li>отсутствие путаницы с путями;</li><li>такое же сопоставление имен пользователей/групп с идентификаторами пользователей/групп;</li><li>отсутствие проблем с правами доступа;</li><li>скорее всего, у вас уже есть рабочая настройка Borg:<ul><li>возможно, с переменной окружения для ключевой фразы (для зашифрованных репозиториев);</li><li>возможно, с файлом ключа для репозитория (не требуется для режима <code>repokey</code>);</li><li>возможно, с SSH-ключом для сервера репозитория (не требуется для локально смонтированных репозиториев);</li><li>возможно, с действительным кэшем Borg для этого репозитория (быстрее, чем его перестройка).</li></ul></li></ul><p><strong>Пользователь</strong> может быть:</p><ul><li><code>root</code> (если были сделаны полные резервные копии, включая системные файлы или файлы нескольких пользователей);</li><li>конкретный пользователь, использующий <code>sudo</code> для выполнения Borg от имени <code>root</code>;</li><li>конкретный пользователь (если были сделаны резервные копии файлов этого пользователя).</li></ul><p><strong>Репозиторий резервного копирования</strong> может быть:</p><ul><li>в локальном каталоге (например, на локально смонтированном USB-накопителе);</li><li>на удаленном сервере резервного копирования, доступном по SSH (клиент/сервер).</li></ul><p>Если репозиторий зашифрован, вам также понадобится <strong>ключ</strong> и <strong>пароль</strong> (который защищает ключ).</p><p><strong>Ключ</strong> может находиться:</p><ul><li><p>в репозитории (<strong>repokey</strong> режим).<br>Это просто, обычно это «просто работает».</p></li><li><p>в домашнем каталоге пользователя, который делал резервную копию (<strong>keyfile</strong> режим).<br>Это может потребовать немного больше усилий:</p><ul><li>если вы только что потеряли этот домашний каталог и вам нужно восстановить ключ Borg (например, из отдельной резервной копии, которую вы сделали, или от другого пользователя или машины, имеющей доступ к тому же репозиторию);</li><li>если вам нужно выяснить правильную машину/пользователя/домашний каталог, где был запущен клиент Borg для создания резервных копий.</li></ul></li></ul><p><strong>Пароль</strong> для ключа может быть:</p><ul><li>введен интерактивно во время резервного копирования (не практично, если резервное копирование автоматизировано/без присмотра);</li><li>получен через механизм, управляемый переменной окружения в скрипте резервного копирования (ищите там <code>BORG_PASSPHRASE</code>, <code>BORG_PASSCOMMAND</code> и т. д. и просто сделайте это так).</li></ul><p>Существуют <strong>два способа восстановить</strong> файлы из репозитория резервного копирования Borg:</p><ul><li><p><strong>borg mount</strong> — используйте это, если:</p><ul><li>вы не совсем знаете, какие файлы хотите восстановить;</li><li>вы не знаете, какой архив содержит нужные файлы;</li><li>вам нужно просмотреть файлы/каталоги перед тем, как решить, что вы хотите;</li><li>вам нужно восстановить относительно небольшой объем данных;</li><li>вам не важен восстановление объектов, которые FUSE-монтирование пока не поддерживает (например, специальные флаги файловой системы, ACL);</li><li>у вас клиент с хорошими ресурсами (ОЗУ, ЦП, временное дисковое пространство);</li><li>вы хотите использовать файловый менеджер для восстановления (копирования) файлов, а не команды оболочки <code>borg extract</code>.</li></ul></li><li><p><strong>borg extract</strong> — используйте это, если:</p><ul><li>вы точно знаете, что хотите (репозиторий, архив, путь);</li><li>вам нужно восстановить большой объем файлов (лучшая скорость);</li><li>вы хотите максимально полное воспроизведение метаданных файлов (например, специальные флаги файловой системы, ACL);</li><li>у вас клиент с низкими ресурсами (ОЗУ, ЦП, временное дисковое пространство).</li></ul></li></ul><h3 id=пример-с-borg-mount>Пример с <strong>borg mount</strong>:<a hidden class=anchor aria-hidden=true href=#пример-с-borg-mount>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Откройте новый, отдельный терминал (этот терминал будет заблокирован до размонтирования).</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Теперь мы узнаем имена архивов, которые у нас есть в репозитории:</span>
</span></span><span style=display:flex><span>borg list /mnt/backup/borg_repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Смонтируем один архив из репозитория Borg:</span>
</span></span><span style=display:flex><span>borg mount /mnt/backup/borg_repo::myserver-system-2019-08-11 /mnt/borg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Альтернативно, смонтируем все архивы из репозитория Borg (медленнее):</span>
</span></span><span style=display:flex><span>borg mount /mnt/backup/borg_repo /mnt/borg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Может потребоваться некоторое время, прежде чем вы увидите содержимое в /mnt/borg.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Теперь используйте другой терминал или файловый браузер и посмотрите содержимое в /mnt/borg.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Когда закончите, размонтируйте, чтобы разблокировать репозиторий и разблокировать терминал:</span>
</span></span><span style=display:flex><span>borg umount /mnt/borg
</span></span></code></pre></div><h3 id=пример-с-borg-extract>Пример с <strong>borg extract</strong>:<a hidden class=anchor aria-hidden=true href=#пример-с-borg-extract>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># borg extract всегда извлекает в текущий каталог, и этот каталог</span>
</span></span><span style=display:flex><span><span style=color:#75715e># должен быть пустым (borg не поддерживает преобразование непустого каталога в</span>
</span></span><span style=display:flex><span><span style=color:#75715e># состояние, которое присутствует в вашем архиве резервной копии).</span>
</span></span><span style=display:flex><span>mkdir borg_restore
</span></span><span style=display:flex><span>cd borg_restore
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Теперь мы узнаем имена архивов, которые у нас есть в репозитории:</span>
</span></span><span style=display:flex><span>borg list /mnt/backup/borg_repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Мы можем выяснить содержимое архива, особенно структуру пути:</span>
</span></span><span style=display:flex><span>borg list /mnt/backup/borg_repo::myserver-system-2019-08-11
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Извлекаем только некоторый конкретный путь (заметьте: без начального / !):</span>
</span></span><span style=display:flex><span>borg extract /mnt/backup/borg_repo::myserver-system-2019-08-11 path/to/extract
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Альтернативно, мы можем полностью извлечь архив:</span>
</span></span><span style=display:flex><span>borg extract /mnt/backup/borg_repo::myserver-system-2019-08-11
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Теперь переместите файлы в нужное место...</span>
</span></span></code></pre></div><h3 id=различия-при-использовании-удаленного-сервера-резервного-копирования-borg>Различия при использовании <strong>удаленного сервера резервного копирования Borg</strong>:<a hidden class=anchor aria-hidden=true href=#различия-при-использовании-удаленного-сервера-резервного-копирования-borg>#</a></h3><p>В целом, все то же самое, что и с локальным репозиторием, но вам нужно ссылаться на репозиторий с помощью URL <code>ssh://</code>.</p><p>В данном примере <code>borg</code> — это имя пользователя, используемое для входа в машину <code>backup.example.org</code>, которая работает по SSH на порту <code>2222</code> и имеет репозиторий Borg в <code>/path/to/repo</code>.</p><p>Вместо указания полного доменного имени (FQDN) или имени хоста вы также можете указать IP-адрес.</p><p>Как обычно, вам нужен либо пароль для входа, либо сервер резервного копирования может иметь аутентификацию, настроенную через SSH <code>authorized_keys</code> (что вероятно, если резервное копирование выполнялось без присмотра).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>borg mount ssh://borg@backup.example.org:2222/path/to/repo /mnt/borg
</span></span><span style=display:flex><span><span style=color:#75715e># или</span>
</span></span><span style=display:flex><span>borg extract ssh://borg@backup.example.org:2222/path/to/repo
</span></span></code></pre></div><p><a href=https://borgbackup.readthedocs.io/en/stable/installation.html title="предыдущая глава (используйте стрелку влево)">Установка</a></p><p><a href=https://borgbackup.readthedocs.io/en/stable/usage.html title="следующая глава (используйте стрелку вправо)">Использование</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://jawerka.github.io/posts/hugo-install/><span class=title>Next »</span><br><span>Установка Hugo</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://jawerka.github.io/>jawerka</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>